import{f as g,a as u,c as Te}from"../chunks/BZqCPlBW.js";import"../chunks/CS0-jjX0.js";import{o as ft,a as gt}from"../chunks/BPGtCBdR.js";import{h as Fe,F as mt,G as $,K as xt,J as v,I as r,z as t,M as O,O as B,P as a,N as S,D as ve}from"../chunks/U2DDJ_0W.js";import{s as c,e as le}from"../chunks/CY5WxPnE.js";import{i as y}from"../chunks/DI9HNUez.js";import{e as ht,s as yt}from"../chunks/C9DCMbO9.js";import{t as bt,s as wt}from"../chunks/BVi6EA_b.js";import{i as $t}from"../chunks/CQGLq4BK.js";function ce(N,ue,p,P,D,Q){var x=N.__className;if(Fe||x!==p||x===void 0){var h=bt(p);(!Fe||h!==N.getAttribute("class"))&&(h==null?N.removeAttribute("class"):N.className=h),N.__className=p}return Q}var St=g('<button class="px-4 py-2 bg-red-700 hover:bg-red-600 text-white rounded-lg transition-colors text-sm font-semibold">üóëÔ∏è Clear Queue</button>'),Nt=g('<div class="card text-center"><p class="text-gray-400">Loading queue...</p></div>'),qt=g('<div class="card border-red-500"><p class="text-red-400"> </p> <button class="btn mt-2">Retry</button></div>'),Ct=g('<div class="card text-center"><p class="text-gray-400">No active jobs. <a href="/" class="text-blue-400 underline">Start a compression</a></p></div>'),Mt=g('<span class="text-lg animate-pulse">‚ö°</span>'),Tt=g('<span class="flex gap-3"><span> </span> <span class="text-blue-300"> </span></span>'),Ft=g('<div class="mb-2"><div class="flex items-center justify-between text-xs text-gray-400 mb-1"><span> </span> <!></div> <div class="h-2 bg-gray-800 rounded"><div class="h-2 bg-blue-600 rounded transition-all"></div></div></div>'),Et=g("<div> </div>"),Dt=g("<div> </div>"),Qt=g("<div> </div>"),kt=g('<div class="mt-2 p-2 bg-red-900/20 border border-red-600/30 rounded text-sm text-red-300"> </div>'),zt=g('<div class="mt-2 p-2 bg-black/30 rounded max-h-48 overflow-y-auto"><pre class="text-xs text-gray-300 whitespace-pre-wrap svelte-qegr5c"> </pre></div>'),Ot=g('<button class="mt-2 text-xs text-blue-400 underline"> </button> <!>',1),Pt=g('<a class="btn bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2" target="_blank">‚¨áÔ∏è Download</a>'),Rt=g('<div><div class="flex items-start justify-between gap-4"><div class="flex-1 min-w-0"><div class="flex items-center gap-2 mb-2"><!> <span class="text-lg"> </span> <span> </span> <span class="text-xs text-gray-500">‚Ä¢</span> <span> </span> <span class="text-xs text-gray-500">‚Ä¢</span> <span class="text-sm text-gray-400 truncate"> </span></div> <!> <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-gray-400"><div> </div> <div> </div> <div> </div> <!> <!> <!></div> <!> <!></div> <div class="flex flex-col gap-2"><!></div></div></div>'),Gt=g('<div class="space-y-4"></div>'),Ht=g('<div class="max-w-6xl mx-auto mt-8 space-y-6 p-4"><div class="flex items-center justify-between mb-4"><h1 class="text-2xl font-bold">Compression Queue</h1> <div class="flex gap-4"><!> <a href="/" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors text-sm">‚Üê Back to Compress</a> <a href="/history" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors text-sm">History</a></div></div> <div class="card"><h2 class="font-semibold mb-3">Queue Summary</h2> <div class="grid grid-cols-3 gap-4"><div class="text-center"><div class="text-2xl font-bold text-yellow-400"> </div> <div class="text-sm text-gray-400">Queued</div></div> <div class="text-center"><div class="text-2xl font-bold text-blue-400"> </div> <div class="text-sm text-gray-400">Running</div></div> <div class="text-center"><div class="text-2xl font-bold text-green-400"> </div> <div class="text-sm text-gray-400">Completed (1h)</div></div></div></div> <!></div>');function Yt(N,ue){mt(ue,!1);let p=O({active_jobs:[],queued_count:0,running_count:0,completed_count:0}),P=O(!0),D=O(null),Q=null,x=new Map,h=O(new Map),q=O(new Set);function Ee(e){if(t(q).has(e))t(q).delete(e);else{t(q).add(e);const i=t(p).active_jobs.find(f=>f.task_id===e);i&&i.state==="running"&&!x.has(e)&&_e(e)}S(q,t(q))}function _e(e){if(!x.has(e))try{const i=new EventSource(`/api/stream/${e}`);x.set(e,i),t(h).has(e)||t(h).set(e,[]),i.onmessage=f=>{var b;try{const d=JSON.parse(f.data),l=t(h).get(e)||[];if(d.type==="log"&&d.message)l.push(d.message),t(h).set(e,l.slice(-100)),S(h,t(h));else if(d.type==="progress"){const m=t(p).active_jobs.find(C=>C.task_id===e);m&&(m.progress=d.progress||m.progress,m.phase=d.phase||m.phase,m.last_progress_update=Date.now()/1e3,S(p,t(p)))}else d.type==="retry"?(l.push(`‚ö†Ô∏è Retry: File exceeded target by ${(b=d.overage_percent)==null?void 0:b.toFixed(1)}%, adjusting bitrate...`),t(h).set(e,l.slice(-100)),S(h,t(h))):(d.type==="done"||d.type==="error"||d.type==="canceled")&&setTimeout(()=>{i.close(),x.delete(e)},1e3)}catch{}},i.onerror=()=>{i.close(),x.delete(e)}}catch(i){console.error("Failed to connect SSE:",i)}}function De(e){const i=x.get(e);if(i){try{i.close()}catch{}x.delete(e)}}async function R(){try{const e=await fetch("/api/queue/status");if(!e.ok)throw new Error(`HTTP ${e.status}`);const i=await e.json();S(p,i);for(const f of t(p).active_jobs)f.state==="running"&&!x.has(f.task_id)&&_e(f.task_id);for(const[f,b]of x.entries()){const d=t(p).active_jobs.find(l=>l.task_id===f);(!d||d.state!=="running")&&De(f)}S(P,!1),S(D,null)}catch(e){S(D,`Failed to load queue: ${e.message||e}`),S(P,!1)}}async function Qe(){if(confirm("Clear all jobs from the queue? This will cancel running jobs and remove all entries."))try{const e=await fetch("/api/queue/clear",{method:"POST"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const i=await e.json();alert(`Queue cleared: ${i.cancelled} job(s) cancelled, ${i.removed} total removed`),await R()}catch(e){alert(`Clear queue failed: ${e.message||e}`)}}function L(e){return e?new Date(e*1e3).toLocaleTimeString():"‚Äî"}function ke(e,i){if(!e)return"‚Äî";const f=Date.now()/1e3,b=Math.round(f-e),d=Math.floor(b/60),l=b%60;return d>0?`${d}m ${l}s`:`${l}s`}function ze(e){if(e.state!=="running"||!e.started_at||e.progress<=0)return"‚Äî";const i=Date.now()/1e3,f=i-e.started_at;if(e.estimated_completion_time&&e.estimated_completion_time>i){const b=Math.round(e.estimated_completion_time-i),d=Math.floor(b/60),l=b%60;return d>0?`~${d}m ${l}s remaining`:`~${l}s remaining`}if(e.progress<100){const b=f/(e.progress/100),d=Math.max(0,Math.round(b-f)),l=Math.floor(d/60),m=d%60;return l>0?`~${l}m ${m}s remaining`:`~${m}s remaining`}return"Finishing..."}function Oe(e){if(e.state==="completed")return"‚úÖ Complete";if(e.state==="failed")return"‚ùå Failed";if(e.state==="canceled")return"üö´ Canceled";if(e.state==="queued")return"‚è≥ Waiting in queue";switch(e.phase){case"encoding":return"üé¨ Encoding video (RUNNING NOW)";case"finalizing":return"‚öôÔ∏è Finalizing output (RUNNING NOW)";case"done":return"‚úÖ Complete";default:return"‚ñ∂Ô∏è Processing (RUNNING NOW)"}}function Pe(e){switch(e){case"queued":return"text-yellow-400";case"running":return"text-blue-400";case"completed":return"text-green-400";case"failed":return"text-red-400";case"canceled":return"text-gray-400";default:return"text-gray-400"}}function Re(e){switch(e){case"queued":return"‚è≥";case"running":return"‚ñ∂Ô∏è";case"completed":return"‚úÖ";case"failed":return"‚ùå";case"canceled":return"üö´";default:return"‚ùì"}}ft(async()=>{await R(),Q=setInterval(R,2e3)}),gt(()=>{Q&&clearInterval(Q);for(const[e,i]of x.entries())try{i.close()}catch{}x.clear()}),$t();var U=Ht(),A=r(U),pe=v(r(A),2),Ge=r(pe);{var He=e=>{var i=St();le("click",i,Qe),u(e,i)};y(Ge,e=>{t(p).active_jobs.length>0&&e(He)})}B(4),a(pe),a(A);var K=v(A,2),fe=v(r(K),2),V=r(fe),ge=r(V),Je=r(ge,!0);a(ge),B(2),a(V);var X=v(V,2),me=r(X),We=r(me,!0);a(me),B(2),a(X);var xe=v(X,2),he=r(xe),Be=r(he,!0);a(he),B(2),a(xe),a(fe),a(K);var Le=v(K,2);{var Ue=e=>{var i=Nt();u(e,i)},Ae=e=>{var i=Te(),f=ve(i);{var b=l=>{var m=qt(),C=r(m),Y=r(C,!0);a(C);var Z=v(C,2);a(m),$(()=>c(Y,t(D))),le("click",Z,R),u(l,m)},d=l=>{var m=Te(),C=ve(m);{var Y=F=>{var k=Ct();u(F,k)},Z=F=>{var k=Gt();ht(k,5,()=>t(p).active_jobs,I=>I.task_id,(I,s)=>{var G=Rt(),ye=r(G),j=r(ye),ee=r(j),be=r(ee);{var Ke=n=>{var o=Mt();u(n,o)};y(be,n=>{t(s).state==="running"&&n(Ke)})}var te=v(be,2),Ve=r(te,!0);a(te);var H=v(te,2),Xe=r(H,!0);a(H);var J=v(H,4),Ye=r(J,!0);a(J);var we=v(J,4),Ze=r(we,!0);a(we),a(ee);var $e=v(ee,2);{var Ie=n=>{var o=Ft(),_=r(o),w=r(_),ne=r(w);a(w);var oe=v(w,2);{var M=T=>{var z=Tt(),de=r(z),ct=r(de);a(de);var Me=v(de,2),ut=r(Me,!0);a(Me),a(z),$((_t,pt)=>{c(ct,`Elapsed: ${_t??""}`),c(ut,pt)},[()=>ke(t(s).started_at),()=>ze(t(s))]),u(T,z)};y(oe,T=>{t(s).state==="running"&&T(M)})}a(_);var E=v(_,2),W=r(E);a(E),a(o),$(T=>{c(ne,`${T??""}%`),wt(W,`width:${t(s).progress}%`)},[()=>t(s).progress.toFixed(1)]),u(n,o)};y($e,n=>{(t(s).state==="running"||t(s).state==="queued")&&n(Ie)})}var ae=v($e,2),re=r(ae),je=r(re);a(re);var se=v(re,2),et=r(se);a(se);var ie=v(se,2),tt=r(ie);a(ie);var Se=v(ie,2);{var at=n=>{var o=Et(),_=r(o);a(o),$(w=>c(_,`Started: ${w??""}`),[()=>L(t(s).started_at)]),u(n,o)};y(Se,n=>{t(s).started_at&&n(at)})}var Ne=v(Se,2);{var rt=n=>{var o=Dt(),_=r(o);a(o),$(w=>c(_,`Completed: ${w??""}`),[()=>L(t(s).completed_at)]),u(n,o)};y(Ne,n=>{t(s).completed_at&&n(rt)})}var st=v(Ne,2);{var it=n=>{var o=Qt(),_=r(o);a(o),$(w=>c(_,`Final: ${w??""} MB`),[()=>t(s).final_size_mb.toFixed(2)]),u(n,o)};y(st,n=>{t(s).final_size_mb&&n(it)})}a(ae);var qe=v(ae,2);{var nt=n=>{var o=kt(),_=r(o,!0);a(o),$(()=>c(_,t(s).error)),u(n,o)};y(qe,n=>{t(s).error&&n(nt)})}var ot=v(qe,2);{var dt=n=>{var o=Ot(),_=ve(o),w=r(_,!0);a(_);var ne=v(_,2);{var oe=M=>{var E=zt(),W=r(E),T=r(W,!0);a(W),a(E),$(z=>c(T,z),[()=>(t(h).get(t(s).task_id)||["Connecting to live stream..."]).join(`
`)]),u(M,E)};y(ne,M=>{t(q).has(t(s).task_id)&&M(oe)})}$(M=>c(w,M),[()=>t(q).has(t(s).task_id)?"‚ñº Hide logs":"‚ñ∂ Show live logs"]),le("click",_,()=>Ee(t(s).task_id)),u(n,o)};y(ot,n=>{t(s).state==="running"&&n(dt)})}a(j);var Ce=v(j,2),vt=r(Ce);{var lt=n=>{var o=Pt();$(()=>yt(o,"href",`/api/jobs/${t(s).task_id}/download`)),u(n,o)};y(vt,n=>{t(s).state==="completed"&&t(s).progress>=100&&t(s).output_path&&n(lt)})}a(Ce),a(ye),a(G),$((n,o,_,w)=>{ce(G,1,`card ${t(s).state==="running"?"border-2 border-blue-500 bg-blue-900/10":""}`),c(Ve,n),ce(H,1,`font-semibold ${o??""} uppercase text-sm`),c(Xe,t(s).state),ce(J,1,`text-sm ${t(s).state==="running"?"text-blue-300 font-semibold":"text-gray-300"}`),c(Ye,_),c(Ze,t(s).filename),c(je,`Target: ${t(s).target_size_mb??""} MB`),c(et,`Codec: ${t(s).video_codec??""}`),c(tt,`Created: ${w??""}`)},[()=>Re(t(s).state),()=>Pe(t(s).state),()=>Oe(t(s)),()=>L(t(s).created_at)]),u(I,G)}),a(k),u(F,k)};y(C,F=>{t(p).active_jobs.length===0?F(Y):F(Z,!1)},!0)}u(l,m)};y(f,l=>{t(D)?l(b):l(d,!1)},!0)}u(e,i)};y(Le,e=>{t(P)?e(Ue):e(Ae,!1)})}a(U),$(()=>{c(Je,t(p).queued_count),c(We,t(p).running_count),c(Be,t(p).completed_count)}),u(N,U),xt()}export{Yt as component};
